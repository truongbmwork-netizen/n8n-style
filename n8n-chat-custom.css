<!-- ================================================================
     CHATBOT SƠN HÙNG - Đoạn mã nhúng HOÀN CHỈNH
     Dán toàn bộ đoạn này vào trang web (trước </body> hoặc trong <head>)
     ================================================================ -->

<link href="https://cdn.jsdelivr.net/gh/truongbmwork-netizen/n8n-style/n8n-chat-custom.css" rel="stylesheet" />

<script type="module">
    import { createChat } from 'https://cdn.jsdelivr.net/gh/truongbmwork-netizen/n8n-style/chat.bundle.js';

    createChat({
        webhookUrl: 'https://oazalo.daotaolaixesonhung.com/webhook/7f4c63cb-8a99-46e1-8aa8-c4431ec9f677/chat',
        showWelcomeScreen: true,
        i18n: {
            en: {
                title: 'Trung tâm Đào tạo lái xe Sơn Hùng',
                subtitle: 'Hỗ trợ giải đáp 24/7',
                footer: '',
                getStarted: 'Bắt đầu trò chuyện',
                inputPlaceholder: 'Nhập câu hỏi của bạn...',
                closeButtonTooltip: 'Đóng',
            }
        }
    });

    /*
     * ✅ Auto open links in new tab
     * Tự động theo dõi khi bot gửi tin nhắn mới có chứa link
     * và mở chúng trong tab/app mới
     */
    (function () {
        function makeLinksOpenNewTab(container) {
            const links = container.querySelectorAll('a[href]');
            links.forEach(function (link) {
                if (!link.dataset.processed) {
                    link.setAttribute('target', '_blank');
                    link.setAttribute('rel', 'noopener noreferrer');
                    link.dataset.processed = 'true';
                }
            });
        }

        // Theo dõi khi có tin nhắn mới xuất hiện trong chat
        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                mutation.addedNodes.forEach(function (node) {
                    if (node.nodeType === 1) {
                        if (node.matches && node.matches('.chat-message-from-bot')) {
                            makeLinksOpenNewTab(node);
                        }
                        const botMessages = node.querySelectorAll && node.querySelectorAll('.chat-message-from-bot');
                        if (botMessages && botMessages.length) {
                            botMessages.forEach(makeLinksOpenNewTab);
                        }
                    }
                });
            });
        });

        // Bắt đầu theo dõi khi chat widget được render xong
        function startObserving() {
            const chatBody = document.querySelector('.chat-body') ||
                document.querySelector('.n8n-chat') ||
                document.body;
            observer.observe(chatBody, { childList: true, subtree: true });
        }

        // Chờ widget load xong rồi mới bắt đầu theo dõi
        if (document.readyState === 'complete') {
            setTimeout(startObserving, 1000);
        } else {
            window.addEventListener('load', function () {
                setTimeout(startObserving, 1000);
            });
        }
    })();
</script>
